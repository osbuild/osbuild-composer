---

- block:

    - name: "Run {{ test.name }} test"
      command: "{{ tests_path }}/{{ test.name }} -test.v -test.coverprofile=coverage.txt"
      args:
        chdir: "{{ tests_working_directory }}"
      register: async_test
      async: "{{ test.timeout * 60 }}"
      poll: "{{ polling_interval }}"
      no_log: yes

    - name: "Mark {{ test.name }} as passed"
      set_fact:
        passed_tests: "{{ passed_tests + [test.name] }}"

    - name: "Send coverage to codecov.io"
      shell: |
        curl -s https://codecov.io/bash > codecov.sh
        chmod a+x codecov.sh
        ./codecov.sh -v
      args:
        warn: no
      register: codecov
    - debug: var=codecov.stdout_lines

  rescue:

    - name: "Mark {{ test.name }} as failed"
      set_fact:
        failed_tests: "{{ failed_tests + [test.name] }}"

  always:

    - name: "Write log for {{ test.name }}"
      copy:
        dest: "{{ workspace }}/{{ test.name }}.log"
        content: |
          Logs from {{ test.name }}
          ----------------------------------------------------------------------
          stderr:
          {{ async_test.stderr }}
          ----------------------------------------------------------------------
          stdout:
          {{ async_test.stdout }}

